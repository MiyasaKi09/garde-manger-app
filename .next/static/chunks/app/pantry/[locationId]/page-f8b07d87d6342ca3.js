(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[642],{5229:function(e,t,r){Promise.resolve().then(r.bind(r,4224))},4224:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return h}});var a=r(7437),n=r(2265),i=r(6463),s=r(5626);function o(e){let{title:t,children:r,...n}=e;return(0,a.jsx)("button",{...n,title:t,className:"btn",style:{background:"#fff",border:"1px solid #dcdce0",borderRadius:8,padding:"4px 6px",lineHeight:1,cursor:"pointer"},children:r})}let l=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e.normalize("NFD").replace(RegExp("\\p{Diacritic}","gu"),"").toLowerCase().trim()};function u(e,t){let r=l(e),a=l(t);return r&&a?a.startsWith(r)?0:a.includes(r)?1:function(e,t){e=l(e),t=l(t);let r=e.length,a=t.length;if(!r)return a;if(!a)return r;let n=Array.from({length:r+1},()=>Array(a+1).fill(0));for(let e=0;e<=r;e++)n[e][0]=e;for(let e=0;e<=a;e++)n[0][e]=e;for(let i=1;i<=r;i++)for(let r=1;r<=a;r++){let a=e[i-1]===t[r-1]?0:1;n[i][r]=Math.min(n[i-1][r]+1,n[i][r-1]+1,n[i-1][r-1]+a)}return n[r][a]}(r,a):999}let d=e=>new Date(Date.now()+864e5*e).toISOString().slice(0,10),c=["Frais","Fruits/L\xe9gumes","Laitier","Fromage","Viande/Poisson","Charcuterie","Boulangerie","Sec","Conserve","Surgel\xe9","Boisson","Autre"],f={Sec:365,Surgelé:180,Conserve:1095,Laitier:7,Fromage:21,Boulangerie:3,Frais:7,"Fruits/L\xe9gumes":7,"Viande/Poisson":2,Charcuterie:5,Boisson:365,Autre:7},p=[{rx:/ya+?ourt|yogh/i,days:14},{rx:/fromage blanc/i,days:14},{rx:/lait|cr[eé]me/i,days:7},{rx:/fromage/i,days:21},{rx:/jambon|charcut/i,days:5},{rx:/p[aâ]tes|riz|farine|semoule|lentilles/i,days:365},{rx:/conserve|cann/i,days:1095},{rx:/sucre|sel|cafe/i,days:365},{rx:/pain|brioche/i,days:3},{rx:/steak|boeuf|veau|agneau|poulet|dinde|porc/i,days:2},{rx:/poisson|saumon|thon|cabillaud/i,days:2},{rx:/tomate.*(c(oe|œur)ur).*boeuf/i,days:7},{rx:/tomate/i,days:7},{rx:/salade|courgette|pomme(?! de terre)|banane|carotte|oignon|poivron|concombre/i,days:7},{rx:/herbe|persil|basilic|coriandre|menthe/i,days:5},{rx:/surg|congel/i,days:180}];function m(e){let{days:t,locationName:r="",isOpened:a=!1,category:n=""}=e,i=(r||"").toLowerCase();return/cong|surg/.test(i)&&(t=Math.max(t,180)),/placard|epicer|cave/.test(i)&&(t=Math.min(t,365)),/frigo|frigidaire/.test(i)&&/(lait|cr[eé]me|fromage|yaourt|charcut)/i.test(n||"")&&(t=Math.max(Math.min(t,21),7)),a&&(t=Math.max(1,Math.round(.6*t))),t=Math.max(t,/(Fruits\/Légumes|Frais)/.test(n||"")?5:3)}function y(e){let{productRow:t,name:r="",category:a="",locationName:n=""}=e;if((null==t?void 0:t.shelf_life_days)&&t.shelf_life_days>0)return{days:m({days:t.shelf_life_days,locationName:n,isOpened:!1,category:t.category||a}),source:"product"};let i="".concat(r," ").concat(a).trim();for(let e of p)if(e.rx.test(i))return{days:m({days:e.days,locationName:n,isOpened:!1,category:a}),source:"keyword"};return a&&null!=f[a]?{days:m({days:f[a],locationName:n,isOpened:!1,category:a}),source:"category"}:{days:m({days:7,locationName:n,isOpened:!1,category:a}),source:"default"}}function g(e,t){return e.reduce((e,r)=>{let a=t(r);return(e[a]=e[a]||[]).push(r),e},{})}function h(){let{locationId:e}=(0,i.useParams)(),[t,r]=(0,n.useState)("…"),[l,f]=(0,n.useState)([]),[p,m]=(0,n.useState)([]),[h,x]=(0,n.useState)([]),[v,b]=(0,n.useState)(""),[_,j]=(0,n.useState)(""),[w,S]=(0,n.useState)("g"),[C,E]=(0,n.useState)(""),[N,k]=(0,n.useState)(!1),[I,O]=(0,n.useState)(null),[L,M]=(0,n.useState)(""),[P,R]=(0,n.useState)(!1),[A,D]=(0,n.useState)(-1),q=(0,n.useRef)(null),B=(0,n.useRef)(null);async function T(){let{data:t}=await s.OQ.from("locations").select("name").eq("id",e).single();t&&r(t.name);let{data:a}=await s.OQ.from("inventory_lots").select("id, qty, unit, dlc, entered_at, product:products_catalog(id,name,default_unit)").eq("location_id",e).order("dlc",{ascending:!0});f(a||[]);let{data:n}=await s.OQ.from("products_catalog").select("id,name,default_unit,category,shelf_life_days,density_g_per_ml,grams_per_unit").order("name");m(n||[]);let{data:i}=await s.OQ.from("product_aliases").select("product_id,alias");x(i||[])}(0,n.useEffect)(()=>{T()},[e]),(0,n.useEffect)(()=>{function e(e){let t=e.target,r=q.current&&q.current.contains(t),a=B.current&&B.current.contains(t);r||a||R(!1)}function t(e){"Escape"===e.key&&R(!1)}return document.addEventListener("pointerdown",e,!0),document.addEventListener("keydown",t,!0),()=>{document.removeEventListener("pointerdown",e,!0),document.removeEventListener("keydown",t,!0)}},[]);let F=(0,n.useMemo)(()=>{let e=v.trim();if(!e)return[];let t=[];for(let r of p)t.push({id:r.id,label:r.name,base:r.name,score:u(e,r.name),unit:r.default_unit||"g"});for(let r of h){let a=p.find(e=>e.id===r.product_id);a&&t.push({id:a.id,label:a.name,base:r.alias,score:u(e,r.alias),unit:a.default_unit||"g"})}let r=new Map;for(let e of t){let t=r.get(e.id);(!t||e.score<t.score)&&r.set(e.id,e)}return Array.from(r.values()).sort((e,t)=>e.score-t.score).slice(0,7)},[v,p,h]),Q=(0,n.useMemo)(()=>I?p.find(e=>e.id===I.id)||I:null,[I,p]),z=(0,n.useMemo)(()=>{if(C)return null;let e=(null==Q?void 0:Q.name)||v.trim();if(!e)return null;let r=L||(null==Q?void 0:Q.category)||"",a=y({productRow:Q,name:e,category:r,locationName:t});return{...a,date:d(a.days)}},[C,v,Q,L,t]);function U(e){b(e.label);let t=p.find(t=>t.id===e.id);t&&(O(t),M(t.category||""),t.default_unit&&S(t.default_unit)),R(!1),setTimeout(()=>{var e;return null===(e=q.current)||void 0===e?void 0:e.focus()},0)}async function J(r){if(r.preventDefault(),!v.trim()||!_)return alert("Produit et quantit\xe9 requis.");k(!0);try{var a;let r=Q;if(!r){let e=F[0];e&&(r=p.find(t=>t.id===e.id))}if(!r)throw Error("Choisis un produit existant (dans la liste). Pour cr\xe9er un nouveau produit, passe par Param\xe8tres → Donn\xe9es.");let n=L||r.category||"";if(n&&n!==r.category&&(await s.OQ.from("products_catalog").update({category:n}).eq("id",r.id),m(e=>e.map(e=>e.id===r.id?{...e,category:n}:e)),r={...r,category:n}),!r.shelf_life_days||r.shelf_life_days<=0){let e=y({productRow:r,name:r.name,category:n,locationName:t});await s.OQ.from("products_catalog").update({shelf_life_days:e.days}).eq("id",r.id),m(t=>t.map(t=>t.id===r.id?{...t,shelf_life_days:e.days}:t)),r={...r,shelf_life_days:e.days}}let i=C||d(y({productRow:r,name:r.name,category:r.category,locationName:t}).days),o=w||r.default_unit||"g",{error:l}=await s.OQ.from("inventory_lots").insert({product_id:r.id,location_id:e,qty:Number(_),unit:o,dlc:i,source:"achat"});if(l)throw l;b(""),j(""),S("g"),E(""),O(null),M(""),await T(),null===(a=q.current)||void 0===a||a.focus()}catch(e){alert(e.message||"Erreur")}finally{k(!1)}}async function V(e){if(!confirm("Retirer ce lot ?"))return;let{error:t}=await s.OQ.from("inventory_lots").delete().eq("id",e);if(t)return alert(t.message);await T()}return g(l,e=>{var t,r;return null!==(r=null===(t=e.product)||void 0===t?void 0:t.name)&&void 0!==r?r:"—"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{children:t}),(0,a.jsxs)("form",{onSubmit:J,className:"card",style:{display:"grid",gap:10,maxWidth:780},children:[(0,a.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"2fr 1fr",gap:10},children:[(0,a.jsxs)("label",{children:["Produit",(0,a.jsxs)("div",{style:{position:"relative"},children:[(0,a.jsx)("input",{ref:q,className:"input",placeholder:"Ex: Tomates",value:v,onChange:e=>{b(e.target.value),R(!0),O(null),M("")},onFocus:()=>R(!0),autoComplete:"off",onKeyDown:e=>{P&&("ArrowDown"===e.key&&(e.preventDefault(),D(e=>Math.min(e+1,F.length-1))),"ArrowUp"===e.key&&(e.preventDefault(),D(e=>Math.max(e-1,0))),"Enter"===e.key&&A>=0&&F[A]&&(e.preventDefault(),U(F[A])),"Escape"===e.key&&R(!1))},required:!0}),P&&v.trim()&&F.length>0&&(0,a.jsx)("div",{ref:B,style:{position:"absolute",top:"100%",left:0,right:0,zIndex:50,background:"#fff",border:"1px solid #dcdce0",borderTop:"none",borderBottomLeftRadius:10,borderBottomRightRadius:10,boxShadow:"0 6px 18px rgba(0,0,0,.06)",maxHeight:260,overflowY:"auto"},children:F.map((e,t)=>(0,a.jsx)("div",{style:{padding:"8px 10px",cursor:"pointer",background:t===A?"#f5f5f7":"transparent"},onMouseEnter:()=>D(t),onMouseDown:()=>U(e),children:(0,a.jsxs)("div",{style:{display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical",overflow:"hidden"},children:[e.label," ",(0,a.jsxs)("span",{style:{opacity:.6,fontSize:12},children:["(",e.unit||"g",")"]})]})},e.id))})]})]}),(0,a.jsxs)("label",{children:["Quantit\xe9",(0,a.jsx)("input",{className:"input",required:!0,type:"number",step:"0.01",min:"0",value:_,onChange:e=>j(e.target.value)})]})]}),(0,a.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},children:[(0,a.jsxs)("label",{children:["Unit\xe9",(0,a.jsx)("select",{className:"input",value:w,onChange:e=>S(e.target.value),children:["g","kg","ml","cl","l","u"].map(e=>(0,a.jsx)("option",{value:e,children:e},e))})]}),(0,a.jsxs)("label",{children:["Cat\xe9gorie ",(null==Q?void 0:Q.category)?(0,a.jsxs)("span",{style:{opacity:.6},children:["(actuelle : ",Q.category,")"]}):(0,a.jsx)("span",{style:{opacity:.6},children:"(non renseign\xe9e)"}),(0,a.jsxs)("select",{className:"input",value:L,onChange:e=>M(e.target.value),children:[(0,a.jsx)("option",{value:"",children:"— choisir (optionnel)"}),c.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]})]}),(0,a.jsx)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10},children:(0,a.jsxs)("label",{children:["DLC",(0,a.jsx)("input",{className:"input",type:"date",value:C,onChange:e=>E(e.target.value)}),!C&&z&&(0,a.jsxs)("div",{style:{fontSize:12,opacity:.75,marginTop:6},children:["Suggestion : ",(0,a.jsx)("strong",{children:z.date})," ",(0,a.jsxs)("span",{style:{opacity:.7},children:["(",z.days," j, source : ",z.source,")"]})]})]})}),(0,a.jsx)("div",{children:(0,a.jsx)("button",{className:"btn primary",type:"submit",disabled:N,children:N?"Ajout…":"Ajouter ici"})})]}),Object.entries(g(l,e=>{var t,r;return null!==(r=null===(t=e.product)||void 0===t?void 0:t.name)&&void 0!==r?r:"—"})).map(e=>{let[t,r]=e;return(0,a.jsxs)("div",{className:"card",children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:[(0,a.jsx)("strong",{children:t}),(0,a.jsxs)("span",{style:{opacity:.6,fontSize:12},children:[r.length," lot(s)"]})]}),(0,a.jsx)("div",{style:{marginTop:6},children:r.map(e=>(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,padding:"6px 0"},children:[(0,a.jsxs)("div",{children:["• ",e.qty," ",e.unit," — DLC ",e.dlc||"—"]}),(0,a.jsx)(o,{title:"Retirer",onClick:()=>V(e.id),children:"✖️"})]},e.id))})]},t)}),0===l.length&&(0,a.jsx)("p",{children:"Aucun produit ici."})]})}},5626:function(e,t,r){"use strict";r.d(t,{OQ:function(){return s}});var a=r(6887);let n="https://yylkwfikfbottngglaxj.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5bGt3ZmlrZmJvdHRuZ2dsYXhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjUwNzAsImV4cCI6MjA3MjE0MTA3MH0.h-GTmBH9onVHNJLLuafw9jwS9G8azVaQGelf-oUK-xc",s=null;if(n&&i)try{console.log("\uD83D\uDD17 Connexion \xe0 Supabase r\xe9el:",n),s=(0,a.eI)(n,i,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})}catch(e){console.error("[Supabase] Erreur lors de la cr\xe9ation du client",e instanceof Error?e:Error(String(e)))}else{let e=[!n&&"NEXT_PUBLIC_SUPABASE_URL",!i&&"NEXT_PUBLIC_SUPABASE_ANON_KEY"].filter(Boolean);Error("Supabase non configur\xe9. Variables manquantes: ".concat(e.join(", ")))}},6463:function(e,t,r){"use strict";var a=r(1169);r.o(a,"useParams")&&r.d(t,{useParams:function(){return a.useParams}}),r.o(a,"usePathname")&&r.d(t,{usePathname:function(){return a.usePathname}}),r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}}),r.o(a,"useSearchParams")&&r.d(t,{useSearchParams:function(){return a.useSearchParams}})}},function(e){e.O(0,[887,971,23,744],function(){return e(e.s=5229)}),_N_E=e.O()}]);