-- Vérifier et créer les recettes manquantes
-- Total recettes dans CSV: 822

BEGIN;

-- Table temporaire avec les IDs de recettes du CSV
CREATE TEMP TABLE csv_recipe_ids (recipe_id INT PRIMARY KEY);


INSERT INTO csv_recipe_ids (recipe_id) VALUES
    (2),
    (3),
    (6),
    (7),
    (8),
    (9),
    (10),
    (11),
    (12),
    (27),
    (29),
    (32),
    (36),
    (37),
    (38),
    (39),
    (40),
    (41),
    (42),
    (43),
    (45),
    (57),
    (58),
    (59),
    (60),
    (61),
    (62),
    (63),
    (64),
    (65),
    (66),
    (67),
    (69),
    (70),
    (71),
    (72),
    (73),
    (74),
    (75),
    (76),
    (77),
    (79),
    (81),
    (82),
    (83),
    (84),
    (85),
    (86),
    (87),
    (88),
    (89),
    (90),
    (91),
    (96),
    (97),
    (99),
    (102),
    (103),
    (104),
    (105),
    (106),
    (107),
    (108),
    (109),
    (110),
    (112),
    (113),
    (116),
    (120),
    (121),
    (122),
    (123),
    (124),
    (125),
    (126),
    (127),
    (128),
    (129),
    (130),
    (131),
    (132),
    (133),
    (134),
    (135),
    (136),
    (137),
    (138),
    (140),
    (141),
    (142),
    (145),
    (146),
    (147),
    (148),
    (149),
    (150),
    (151),
    (153),
    (154),
    (155),
    (156),
    (158),
    (159),
    (160),
    (161),
    (162),
    (163),
    (164),
    (165),
    (166),
    (167),
    (170),
    (173),
    (174),
    (175),
    (176),
    (178),
    (179),
    (180),
    (181),
    (185),
    (186),
    (187),
    (188),
    (190),
    (191),
    (192),
    (194),
    (195),
    (196),
    (261),
    (262),
    (263),
    (264),
    (265),
    (412),
    (413),
    (452),
    (453),
    (454),
    (512),
    (8776),
    (8838),
    (8869),
    (8870),
    (8873),
    (8877),
    (8878),
    (8880),
    (8893),
    (8894),
    (379),
    (380),
    (372),
    (256),
    (303),
    (317),
    (420),
    (421),
    (422),
    (9377),
    (9386),
    (9388),
    (205),
    (206),
    (207),
    (243),
    (249),
    (255),
    (267),
    (282),
    (293),
    (307),
    (315),
    (316),
    (322),
    (330),
    (333),
    (392),
    (396),
    (416),
    (417),
    (419),
    (432),
    (455),
    (476),
    (8772),
    (8773),
    (8785),
    (8928),
    (8936),
    (9040),
    (526),
    (540),
    (570),
    (188),
    (197),
    (198),
    (199),
    (200),
    (201),
    (202),
    (203),
    (204),
    (208),
    (209),
    (211),
    (215),
    (217),
    (218),
    (220),
    (221),
    (223),
    (224),
    (225),
    (226),
    (227),
    (229),
    (231),
    (233),
    (234),
    (235),
    (236),
    (238),
    (239),
    (240),
    (241),
    (245),
    (247),
    (250),
    (251),
    (252),
    (253),
    (254),
    (268),
    (269),
    (270),
    (271),
    (272),
    (273),
    (274),
    (276),
    (278),
    (279),
    (281),
    (283),
    (284),
    (285),
    (287),
    (288),
    (289),
    (290),
    (291),
    (292),
    (295),
    (296),
    (308),
    (309),
    (314),
    (318),
    (320),
    (321),
    (323),
    (325),
    (326),
    (327),
    (328),
    (329),
    (331),
    (336),
    (337),
    (338),
    (339),
    (340),
    (342),
    (343),
    (344),
    (345),
    (347),
    (348),
    (349),
    (350),
    (351),
    (353),
    (367),
    (368),
    (370),
    (373),
    (374),
    (375),
    (381),
    (382),
    (383),
    (384),
    (385),
    (386),
    (388),
    (389),
    (393),
    (394),
    (395),
    (397),
    (398),
    (399),
    (400),
    (401),
    (403),
    (405),
    (406),
    (407),
    (408),
    (409),
    (410),
    (411),
    (414),
    (415),
    (418),
    (423),
    (424),
    (425),
    (426),
    (427),
    (428),
    (429),
    (430),
    (433),
    (434),
    (435),
    (436),
    (437),
    (438),
    (439),
    (440),
    (441),
    (442),
    (443),
    (444),
    (445),
    (446),
    (447),
    (449),
    (450),
    (451),
    (456),
    (457),
    (458),
    (459),
    (460),
    (461),
    (462),
    (463),
    (464),
    (465),
    (466),
    (468),
    (469),
    (470),
    (471),
    (472),
    (473),
    (474),
    (475),
    (477),
    (478),
    (479),
    (480),
    (481),
    (482),
    (483),
    (484),
    (485),
    (486),
    (487),
    (488),
    (489),
    (490),
    (491),
    (494),
    (496),
    (497),
    (498),
    (499),
    (504),
    (505),
    (506),
    (507),
    (508),
    (509),
    (510),
    (511),
    (520),
    (521),
    (523),
    (524),
    (531),
    (533),
    (534),
    (536),
    (537),
    (538),
    (539),
    (541),
    (542),
    (543),
    (544),
    (545),
    (546),
    (547),
    (548),
    (549),
    (550),
    (551),
    (553),
    (554),
    (558),
    (559),
    (562),
    (563),
    (564),
    (565),
    (566),
    (568),
    (569),
    (571),
    (572),
    (573),
    (574),
    (575),
    (576),
    (577),
    (578),
    (579),
    (580),
    (581),
    (582),
    (583),
    (584),
    (585),
    (586),
    (587),
    (588),
    (589),
    (590),
    (591),
    (595),
    (596),
    (597),
    (598),
    (599),
    (600),
    (601),
    (602),
    (603),
    (604),
    (605),
    (607),
    (608),
    (609),
    (611),
    (612),
    (614),
    (615),
    (616),
    (617),
    (618),
    (619),
    (620),
    (621),
    (623),
    (624),
    (628),
    (629),
    (630),
    (634),
    (635),
    (636),
    (638),
    (639),
    (266),
    (8854),
    (8855),
    (8856),
    (8857),
    (8858),
    (8859),
    (8860),
    (8861),
    (8862),
    (8863),
    (8864),
    (8865),
    (8866),
    (8867),
    (8868),
    (8871),
    (8872),
    (8874),
    (8875),
    (8876),
    (8879),
    (8881),
    (8882),
    (8883),
    (8884),
    (8885),
    (8886),
    (8887),
    (8888),
    (8889),
    (8890),
    (8891),
    (8892),
    (8896),
    (8897),
    (8898),
    (8899),
    (8900),
    (8901),
    (8902),
    (8903),
    (8904),
    (8905),
    (8906),
    (8907),
    (8908),
    (8909),
    (8910),
    (8911),
    (8912),
    (8913),
    (8914),
    (8916),
    (8917),
    (8918),
    (8919),
    (8920),
    (8921),
    (8922),
    (8923),
    (8924),
    (8925),
    (8926),
    (8929),
    (8930),
    (8931),
    (8932),
    (8933),
    (8934),
    (8935),
    (8937),
    (8938),
    (8939),
    (8940),
    (8941),
    (8942),
    (8943),
    (8944),
    (8945),
    (8946),
    (8947),
    (8948),
    (8949),
    (8950),
    (8951),
    (8952),
    (8953),
    (8954),
    (8955),
    (8956),
    (8957),
    (8958),
    (8959),
    (8960),
    (8961),
    (8962),
    (8963),
    (8964),
    (8965),
    (8966),
    (8967),
    (8968),
    (8969),
    (8970),
    (8971),
    (8972),
    (8973),
    (8974),
    (8975),
    (8976),
    (8977),
    (8978),
    (8979),
    (8980),
    (8981),
    (8982),
    (8983),
    (8984),
    (8985),
    (8986),
    (8987),
    (8988),
    (8989),
    (8990),
    (8991),
    (8992),
    (8993),
    (8994),
    (8995),
    (8996),
    (8997),
    (9007),
    (9010),
    (9011),
    (9012),
    (9013),
    (9014),
    (9015),
    (9016),
    (9019),
    (9020),
    (9021),
    (9025),
    (9027),
    (9029),
    (9030),
    (9031),
    (9032),
    (9034),
    (9035),
    (9036),
    (9038),
    (9041),
    (9042),
    (9043),
    (9044),
    (9045),
    (9046),
    (9047),
    (9048),
    (9049),
    (9050),
    (9076),
    (9078),
    (9079),
    (9083),
    (9087),
    (9094),
    (9095),
    (9097),
    (9098),
    (9099),
    (9100),
    (9101),
    (9103),
    (9104),
    (9105),
    (9106),
    (9107),
    (9109),
    (9110),
    (9111),
    (9112),
    (9113),
    (9114),
    (9115),
    (9116),
    (9117),
    (9118),
    (9119),
    (9120),
    (9121),
    (9122),
    (9123),
    (9124),
    (9125),
    (9127),
    (9128),
    (9129),
    (9130),
    (9132),
    (9133),
    (9134),
    (9135),
    (9136),
    (9140),
    (9141),
    (9142),
    (9146),
    (9147),
    (9150),
    (9153),
    (9154),
    (9155),
    (9156),
    (9157),
    (9158),
    (9163),
    (9164),
    (9165),
    (9172),
    (9176),
    (9177),
    (9181),
    (9182),
    (9186),
    (9187),
    (9188),
    (9189),
    (9191),
    (9199),
    (9201),
    (9203),
    (9205),
    (9208),
    (9209),
    (9225),
    (9226),
    (9230),
    (9232),
    (9233),
    (9236),
    (9237),
    (9238),
    (9239),
    (9240),
    (9241),
    (9242),
    (9243),
    (9244),
    (9250),
    (9251),
    (9252),
    (9254),
    (9258),
    (9259),
    (9260),
    (9261),
    (9262),
    (9269),
    (9270),
    (9271),
    (9272),
    (9278),
    (9279),
    (9280),
    (9281),
    (9282),
    (9283),
    (9284),
    (9290),
    (9291),
    (9296),
    (9297),
    (9298),
    (9299),
    (9300),
    (9301),
    (9302),
    (9303),
    (9304),
    (9305),
    (9306),
    (9307),
    (9308),
    (9310),
    (9311),
    (9312),
    (9313),
    (9314),
    (9315),
    (9316),
    (9317),
    (9318),
    (9319),
    (9321),
    (9323),
    (9324),
    (9325),
    (9330),
    (9340),
    (9341),
    (9342),
    (9344),
    (9345),
    (9346),
    (9347),
    (9348),
    (9349),
    (9350),
    (9351),
    (9352),
    (9353),
    (9355),
    (9360),
    (9361),
    (9363),
    (9364),
    (9365),
    (9366),
    (9368),
    (9370),
    (9378),
    (9379),
    (9380),
    (9381),
    (9382),
    (9383),
    (9384),
    (9385),
    (9387),
    (9389),
    (9390),
    (9391),
    (9392),
    (9393),
    (9394),
    (9395),
    (9396),
    (9397),
    (9398),
    (9399),
    (9400);

-- Rapport: Recettes manquantes
DO $$
DECLARE
    missing_count INT;
    existing_count INT;
BEGIN
    SELECT COUNT(*) INTO missing_count
    FROM csv_recipe_ids csv
    WHERE NOT EXISTS (SELECT 1 FROM recipes r WHERE r.id = csv.recipe_id);
    
    SELECT COUNT(*) INTO existing_count
    FROM csv_recipe_ids csv
    WHERE EXISTS (SELECT 1 FROM recipes r WHERE r.id = csv.recipe_id);
    
    RAISE NOTICE '========================================================';
    RAISE NOTICE 'Rapport: Recettes CSV vs Base de données';
    RAISE NOTICE '========================================================';
    RAISE NOTICE 'Recettes dans CSV        : %', (SELECT COUNT(*) FROM csv_recipe_ids);
    RAISE NOTICE 'Recettes existantes      : %', existing_count;
    RAISE NOTICE 'Recettes manquantes      : %', missing_count;
    RAISE NOTICE '========================================================';
    
    IF missing_count > 0 THEN
        RAISE NOTICE '';
        RAISE NOTICE 'IDs des recettes manquantes (20 premiers):';
        FOR i IN (
            SELECT csv.recipe_id
            FROM csv_recipe_ids csv
            WHERE NOT EXISTS (SELECT 1 FROM recipes r WHERE r.id = csv.recipe_id)
            ORDER BY csv.recipe_id
            LIMIT 20
        )
        LOOP
            RAISE NOTICE '  • Recette ID: %', i.recipe_id;
        END LOOP;
    END IF;
END $$;

DROP TABLE csv_recipe_ids;

COMMIT;
