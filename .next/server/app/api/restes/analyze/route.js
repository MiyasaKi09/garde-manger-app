"use strict";(()=>{var e={};e.id=34,e.ids=[34],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},6476:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var n={};r.r(n),r.d(n,{GET:()=>l,POST:()=>c});var o=r(9303),a=r(8716),i=r(670),s=r(7070),u=r(110);async function c(e){try{let{userId:t,daysThreshold:r=7,includeOpened:n=!0,includeStats:o=!0,includeRecipeSuggestions:a=!0}=await e.json();if(!t)return s.NextResponse.json({error:"userId est requis"},{status:400});let i=await (0,u.b3)(t,{daysThreshold:r,includeOpened:n}),c=null;a&&i.risks.length>0&&(c=await (0,u.ht)(t,i));let l=null;return o&&(l=await (0,u.Cr)(t,"month")),s.NextResponse.json({success:!0,analysis:i,recipeSuggestions:c,stats:l,timestamp:new Date().toISOString()})}catch(e){return console.error("Erreur API analyze:",e),s.NextResponse.json({error:"Erreur lors de l'analyse",message:e.message},{status:500})}}async function l(e){return s.NextResponse.json({endpoint:"POST /api/restes/analyze",description:"Analyse l'inventaire pour identifier les produits \xe0 risque de gaspillage",parameters:{userId:"UUID de l'utilisateur (requis)",daysThreshold:"Nombre de jours avant expiration (d\xe9faut: 7)",includeOpened:"Inclure les produits ouverts (d\xe9faut: true)",includeStats:"Inclure les statistiques (d\xe9faut: true)",includeRecipeSuggestions:"Inclure suggestions de recettes (d\xe9faut: true)"},example:{userId:"uuid-123",daysThreshold:7,includeOpened:!0,includeStats:!0,includeRecipeSuggestions:!0},response:{analysis:{risks:"[Array of products at risk]",stats:"{Statistics about risks}",summary:"{Summary message}"},recipeSuggestions:{suggestions:"[Array of recipe suggestions]",message:"Summary message"},stats:{period:"month",totalActionsTaken:0,quantitySaved:0,estimatedMoneySaved:0,co2Saved:0}}})}let d=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/restes/analyze/route",pathname:"/api/restes/analyze",filename:"route",bundlePath:"app/api/restes/analyze/route"},resolvedPagePath:"/workspaces/garde-manger-app/app/api/restes/analyze/route.js",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:m}=d,y="/api/restes/analyze/route";function f(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}},7043:(e,t,r)=>{r.d(t,{OQ:()=>i});var n=r(9498);let o="https://yylkwfikfbottngglaxj.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5bGt3ZmlrZmJvdHRuZ2dsYXhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjUwNzAsImV4cCI6MjA3MjE0MTA3MH0.h-GTmBH9onVHNJLLuafw9jwS9G8azVaQGelf-oUK-xc",i=null;if(o&&a)try{console.log("\uD83D\uDD17 Connexion \xe0 Supabase r\xe9el:",o),i=(0,n.eI)(o,a,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})}catch(e){console.error("[Supabase] Erreur lors de la cr\xe9ation du client",e instanceof Error?e:Error(String(e)))}else{let e=[!o&&"NEXT_PUBLIC_SUPABASE_URL",!a&&"NEXT_PUBLIC_SUPABASE_ANON_KEY"].filter(Boolean);Error(`Supabase non configur\xe9. Variables manquantes: ${e.join(", ")}`)}},110:(e,t,r)=>{r.d(t,{Cr:()=>d,UX:()=>l,b3:()=>u,ht:()=>c});var n=r(7043);let o={CRITICAL:{days:0,label:"CRITIQUE",color:"#ef4444",score:100},URGENT:{days:1,label:"URGENT",color:"#f97316",score:85},WARNING:{days:3,label:"ATTENTION",color:"#f59e0b",score:65},SOON:{days:7,label:"BIENT\xd4T",color:"#eab308",score:40},NORMAL:{days:14,label:"NORMAL",color:"#84cc16",score:20},FRESH:{days:1/0,label:"FRAIS",color:"#22c55e",score:0}},a={FREEZE:{id:"freeze",label:"Congeler",icon:"\uD83E\uDDCA",description:"Prolonger de plusieurs mois",canFreeze:e=>!["Salade","Concombre","Tomate"].includes(e.name)},PRESERVE:{id:"preserve",label:"Conserver",icon:"\uD83E\uDD6B",description:"Faire une conserve/confiture",canPreserve:e=>["Fruits","L\xe9gumes","Viande"].some(t=>e.category?.toLowerCase().includes(t.toLowerCase()))},COOK:{id:"cook",label:"Cuisiner",icon:"\uD83D\uDC68â€\uD83C\uDF73",description:"Utiliser dans une recette",canCook:()=>!0},TRANSFORM:{id:"transform",label:"Transformer",icon:"\uD83D\uDD04",description:"Compote, soupe, etc.",canTransform:e=>["Fruits","L\xe9gumes"].some(t=>e.category?.toLowerCase().includes(t.toLowerCase()))},SHARE:{id:"share",label:"Partager",icon:"\uD83E\uDD1D",description:"Donner \xe0 un voisin/association",canShare:()=>!0}};function i(e){if(!e)return null;let t=new Date;t.setHours(0,0,0,0);let r=new Date(e);return r.setHours(0,0,0,0),Math.ceil((r-t)/864e5)}function s(e){return null===e?o.NORMAL:e<0?o.CRITICAL:e<=o.URGENT.days?o.URGENT:e<=o.WARNING.days?o.WARNING:e<=o.SOON.days?o.SOON:e<=o.NORMAL.days?o.NORMAL:o.FRESH}async function u(e,t={}){let{daysThreshold:r=7,includeOpened:o=!0,minUrgencyScore:u=40}=t;try{let{data:t,error:c}=await n.OQ.from("inventory_lots").select(`
        id,
        qty,
        qty_remaining,
        unit,
        dlc,
        expiration_date,
        effective_expiration,
        opened_at,
        location_id,
        product_id,
        product:products_catalog(
          id,
          name,
          category,
          default_unit
        ),
        location:locations(
          name,
          icon
        )
      `).eq("user_id",e).order("dlc",{ascending:!0});if(c)throw c;let l=[],d={totalAtRisk:0,criticalCount:0,urgentCount:0,warningCount:0,totalQuantityAtRisk:0,categoriesAtRisk:{}};for(let e of t||[]){let t=i(e.dlc||e.expiration_date||e.effective_expiration);if(null===t||t>r&&!e.opened_at||!o&&!e.opened_at&&t>r)continue;let n=s(t),c=function(e){let t=s(i(e.dlc||e.expiration_date||e.effective_expiration)).score;e.opened_at&&(t+=15);let r=parseFloat(e.qty_remaining||e.qty||0);return r>10?t+=10:r>5&&(t+=5),Math.min(100,t)}(e);if(c<u)continue;let p=Object.values(a).filter(t=>t.canFreeze?.(e.product)??t.canPreserve?.(e.product)??t.canCook?.()??t.canTransform?.(e.product)??t.canShare?.()??!1).map(e=>({id:e.id,label:e.label,icon:e.icon,description:e.description})),g={lotId:e.id,productId:e.product?.id,productName:e.product?.name||"Produit inconnu",category:e.product?.category,quantity:e.qty_remaining||e.qty||0,unit:e.unit||e.product?.default_unit||"u",daysLeft:t,expirationDate:e.dlc||e.expiration_date||e.effective_expiration,isOpened:!!e.opened_at,openedAt:e.opened_at,location:e.location?.name||"Non sp\xe9cifi\xe9",locationIcon:e.location?.icon||"\uD83D\uDCE6",urgency:{level:n.label,color:n.color,score:c},actions:p,recommendation:"CRITIQUE"===n.label?`âš ï¸ URGENT : V\xe9rifier l'\xe9tat et d\xe9cider imm\xe9diatement (cuisiner, congeler ou jeter si p\xe9rim\xe9)`:"URGENT"===n.label?`ðŸ”¥ \xc0 consommer ou congeler aujourd'hui`:"ATTENTION"===n.label?`â° Planifier utilisation dans les 3 prochains jours`:"BIENT\xd4T"===n.label?`ðŸ“… \xc0 pr\xe9voir dans la semaine`:e.opened_at?`ðŸ“¦ Lot ouvert : \xe0 surveiller`:`âœ… Rien \xe0 signaler`};l.push(g),d.totalAtRisk++,"CRITIQUE"===n.label?d.criticalCount++:"URGENT"===n.label?d.urgentCount++:"ATTENTION"===n.label&&d.warningCount++,d.totalQuantityAtRisk+=parseFloat(g.quantity||0);let m=g.category||"Autre";d.categoriesAtRisk[m]=(d.categoriesAtRisk[m]||0)+1}return l.sort((e,t)=>t.urgency.score-e.urgency.score),{risks:l,stats:d,summary:{total:d.totalAtRisk,critical:d.criticalCount,urgent:d.urgentCount,warning:d.warningCount,message:d.criticalCount>0?`âš ï¸ ${d.criticalCount} produit(s) n\xe9cessitent une action imm\xe9diate !`:d.urgentCount>0?`ðŸ”¥ ${d.urgentCount} produit(s) \xe0 consommer ou congeler rapidement`:d.warningCount>0?`â° ${d.warningCount} produit(s) \xe0 surveiller cette semaine`:`âœ… Pas de produits urgents \xe0 g\xe9rer`}}}catch(e){throw console.error("Erreur analyse anti-gaspillage:",e),e}}async function c(e,t){try{if(!t?.risks||0===t.risks.length)return{suggestions:[],message:"Aucun produit \xe0 risque"};let e=t.risks.slice(0,5).map(e=>e.productName),{data:r,error:o}=await n.OQ.from("recipes").select(`
        id,
        name,
        description,
        prep_time_minutes,
        cook_time_minutes,
        servings,
        role,
        recipe_ingredients!inner(
          id,
          quantity,
          unit,
          notes
        )
      `).limit(20);if(o)throw o;let a=[];for(let n of r||[]){let r=e.filter(e=>{let t=n.name.toLowerCase(),r=(n.description||"").toLowerCase(),o=e.toLowerCase();return t.includes(o)||r.includes(o)});r.length>0&&a.push({recipeId:n.id,recipeName:n.name,description:n.description,prepTime:n.prep_time_minutes,cookTime:n.cook_time_minutes,servings:n.servings,role:n.role,matchingProducts:r,matchCount:r.length,wasteReduction:function(e,t){let r=0;for(let n of e){let e=t.risks.find(e=>e.productName===n);e&&(r+=parseFloat(e.quantity||0))}return{quantity:Math.round(10*r)/10,estimatedValue:Math.round(5*r),co2:Math.round(25*r)/10}}(r,t),urgencyScore:r.reduce((e,r)=>{let n=t.risks.find(e=>e.productName===r);return e+(n?.urgency?.score||0)},0)/r.length})}return a.sort((e,t)=>t.matchCount!==e.matchCount?t.matchCount-e.matchCount:t.urgencyScore-e.urgencyScore),{suggestions:a.slice(0,10),message:a.length>0?`${a.length} recettes trouv\xe9es pour sauver vos produits`:"Aucune recette trouv\xe9e avec ces ingr\xe9dients"}}catch(e){throw console.error("Erreur suggestions recettes:",e),e}}async function l(e,t){let{lotId:r,actionType:o,quantitySaved:a,notes:i}=t;try{let{data:s,error:u}=await n.OQ.from("waste_prevention_log").insert({user_id:e,lot_id:r,action_type:o,quantity_saved:a,notes:i,created_at:new Date().toISOString()}).select().single();if(u)return console.log("Action anti-gaspillage:",t),{success:!0,logged:!1};return{success:!0,logged:!0,data:s}}catch(e){return console.error("Erreur log action:",e),{success:!1,error:e.message}}}async function d(e,t="month"){try{let r;let o=new Date;switch(t){case"week":r=new Date(o.getTime()-6048e5);break;case"month":default:r=new Date(o.getFullYear(),o.getMonth(),1);break;case"year":r=new Date(o.getFullYear(),0,1)}let{data:a,error:i}=await n.OQ.from("waste_prevention_log").select("*").eq("user_id",e).gte("created_at",r.toISOString());if(i&&"PGRST116"!==i.code)throw i;let s={period:t,totalActionsTaken:a?.length||0,quantitySaved:a?.reduce((e,t)=>e+(parseFloat(t.quantity_saved)||0),0)||0,actionBreakdown:{},estimatedMoneySaved:0,co2Saved:0};for(let e of a||[]){let t=e.action_type;s.actionBreakdown[t]=(s.actionBreakdown[t]||0)+1}return s.estimatedMoneySaved=Math.round(5*s.quantitySaved),s.co2Saved=Math.round(25*s.quantitySaved)/10,s}catch(e){return console.error("Erreur calcul stats:",e),{period:t,totalActionsTaken:0,quantitySaved:0,actionBreakdown:{},estimatedMoneySaved:0,co2Saved:0}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,766,70],()=>r(6476));module.exports=n})();