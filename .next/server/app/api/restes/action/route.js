"use strict";(()=>{var e={};e.id=188,e.ids=[188],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},4630:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g});var o={};r.r(o),r.d(o,{GET:()=>d,POST:()=>l});var n=r(9303),a=r(8716),i=r(670),s=r(7070),u=r(110),c=r(7043);async function l(e){try{let{userId:t,lotId:r,actionType:o,quantitySaved:n,notes:a}=await e.json();if(!t||!r||!o)return s.NextResponse.json({error:"userId, lotId et actionType sont requis"},{status:400});let i=["freeze","preserve","cook","transform","share","consumed"];if(!i.includes(o))return s.NextResponse.json({error:`actionType doit \xeatre: ${i.join(", ")}`},{status:400});let l=await (0,u.UX)(t,{lotId:r,actionType:o,quantitySaved:n||0,notes:a}),d=null;if("freeze"===o){let{data:e,error:o}=await c.OQ.from("inventory_lots").update({storage_method:"freezer"}).eq("id",r).eq("user_id",t).select();d={action:"freeze",data:e,error:o}}if("consumed"===o){let{data:e,error:o}=await c.OQ.from("inventory_lots").update({qty_remaining:0,consumed_at:new Date().toISOString()}).eq("id",r).eq("user_id",t).select();d={action:"consumed",data:e,error:o}}return s.NextResponse.json({success:!0,action:l,update:d,message:{freeze:"\uD83E\uDDCA Produit congel\xe9 avec succ\xe8s ! Il se conservera plusieurs mois.",preserve:"\uD83E\uDD6B Conservation enregistr\xe9e ! Pensez \xe0 \xe9tiqueter avec la date.",cook:"\uD83D\uDC68â€\uD83C\uDF73 Recette ajout\xe9e au planning ! Bon app\xe9tit.",transform:"\uD83D\uDD04 Transformation enregistr\xe9e ! Produit sauv\xe9 du gaspillage.",share:"\uD83E\uDD1D Partage enregistr\xe9 ! Merci pour votre g\xe9n\xe9rosit\xe9.",consumed:"âœ… Produit consomm\xe9 ! Z\xe9ro gaspillage."}[o]||"âœ… Action enregistr\xe9e avec succ\xe8s !",timestamp:new Date().toISOString()})}catch(e){return console.error("Erreur API action:",e),s.NextResponse.json({error:"Erreur lors de l'enregistrement de l'action",message:e.message},{status:500})}}async function d(e){return s.NextResponse.json({endpoint:"POST /api/restes/action",description:"Enregistre une action de pr\xe9vention du gaspillage",parameters:{userId:"UUID de l'utilisateur (requis)",lotId:"ID du lot concern\xe9 (requis)",actionType:"Type d'action: freeze, preserve, cook, transform, share, consumed (requis)",quantitySaved:"Quantit\xe9 sauv\xe9e (optionnel)",notes:"Notes additionnelles (optionnel)"},validActions:["freeze","preserve","cook","transform","share","consumed"],example:{userId:"uuid-123",lotId:"lot-456",actionType:"freeze",quantitySaved:500,notes:"Congel\xe9 pour une utilisation ult\xe9rieure"}})}let p=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/restes/action/route",pathname:"/api/restes/action",filename:"route",bundlePath:"app/api/restes/action/route"},resolvedPagePath:"/workspaces/garde-manger-app/app/api/restes/action/route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:f}=p,y="/api/restes/action/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},7043:(e,t,r)=>{r.d(t,{OQ:()=>i});var o=r(9498);let n="https://yylkwfikfbottngglaxj.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5bGt3ZmlrZmJvdHRuZ2dsYXhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjUwNzAsImV4cCI6MjA3MjE0MTA3MH0.h-GTmBH9onVHNJLLuafw9jwS9G8azVaQGelf-oUK-xc",i=null;if(n&&a)try{console.log("\uD83D\uDD17 Connexion \xe0 Supabase r\xe9el:",n),i=(0,o.eI)(n,a,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})}catch(e){console.error("[Supabase] Erreur lors de la cr\xe9ation du client",e instanceof Error?e:Error(String(e)))}else{let e=[!n&&"NEXT_PUBLIC_SUPABASE_URL",!a&&"NEXT_PUBLIC_SUPABASE_ANON_KEY"].filter(Boolean);Error(`Supabase non configur\xe9. Variables manquantes: ${e.join(", ")}`)}},110:(e,t,r)=>{r.d(t,{Cr:()=>d,UX:()=>l,b3:()=>u,ht:()=>c});var o=r(7043);let n={CRITICAL:{days:0,label:"CRITIQUE",color:"#ef4444",score:100},URGENT:{days:1,label:"URGENT",color:"#f97316",score:85},WARNING:{days:3,label:"ATTENTION",color:"#f59e0b",score:65},SOON:{days:7,label:"BIENT\xd4T",color:"#eab308",score:40},NORMAL:{days:14,label:"NORMAL",color:"#84cc16",score:20},FRESH:{days:1/0,label:"FRAIS",color:"#22c55e",score:0}},a={FREEZE:{id:"freeze",label:"Congeler",icon:"\uD83E\uDDCA",description:"Prolonger de plusieurs mois",canFreeze:e=>!["Salade","Concombre","Tomate"].includes(e.name)},PRESERVE:{id:"preserve",label:"Conserver",icon:"\uD83E\uDD6B",description:"Faire une conserve/confiture",canPreserve:e=>["Fruits","L\xe9gumes","Viande"].some(t=>e.category?.toLowerCase().includes(t.toLowerCase()))},COOK:{id:"cook",label:"Cuisiner",icon:"\uD83D\uDC68â€\uD83C\uDF73",description:"Utiliser dans une recette",canCook:()=>!0},TRANSFORM:{id:"transform",label:"Transformer",icon:"\uD83D\uDD04",description:"Compote, soupe, etc.",canTransform:e=>["Fruits","L\xe9gumes"].some(t=>e.category?.toLowerCase().includes(t.toLowerCase()))},SHARE:{id:"share",label:"Partager",icon:"\uD83E\uDD1D",description:"Donner \xe0 un voisin/association",canShare:()=>!0}};function i(e){if(!e)return null;let t=new Date;t.setHours(0,0,0,0);let r=new Date(e);return r.setHours(0,0,0,0),Math.ceil((r-t)/864e5)}function s(e){return null===e?n.NORMAL:e<0?n.CRITICAL:e<=n.URGENT.days?n.URGENT:e<=n.WARNING.days?n.WARNING:e<=n.SOON.days?n.SOON:e<=n.NORMAL.days?n.NORMAL:n.FRESH}async function u(e,t={}){let{daysThreshold:r=7,includeOpened:n=!0,minUrgencyScore:u=40}=t;try{let{data:t,error:c}=await o.OQ.from("inventory_lots").select(`
        id,
        qty,
        qty_remaining,
        unit,
        dlc,
        expiration_date,
        effective_expiration,
        opened_at,
        location_id,
        product_id,
        product:products_catalog(
          id,
          name,
          category,
          default_unit
        ),
        location:locations(
          name,
          icon
        )
      `).eq("user_id",e).order("dlc",{ascending:!0});if(c)throw c;let l=[],d={totalAtRisk:0,criticalCount:0,urgentCount:0,warningCount:0,totalQuantityAtRisk:0,categoriesAtRisk:{}};for(let e of t||[]){let t=i(e.dlc||e.expiration_date||e.effective_expiration);if(null===t||t>r&&!e.opened_at||!n&&!e.opened_at&&t>r)continue;let o=s(t),c=function(e){let t=s(i(e.dlc||e.expiration_date||e.effective_expiration)).score;e.opened_at&&(t+=15);let r=parseFloat(e.qty_remaining||e.qty||0);return r>10?t+=10:r>5&&(t+=5),Math.min(100,t)}(e);if(c<u)continue;let p=Object.values(a).filter(t=>t.canFreeze?.(e.product)??t.canPreserve?.(e.product)??t.canCook?.()??t.canTransform?.(e.product)??t.canShare?.()??!1).map(e=>({id:e.id,label:e.label,icon:e.icon,description:e.description})),m={lotId:e.id,productId:e.product?.id,productName:e.product?.name||"Produit inconnu",category:e.product?.category,quantity:e.qty_remaining||e.qty||0,unit:e.unit||e.product?.default_unit||"u",daysLeft:t,expirationDate:e.dlc||e.expiration_date||e.effective_expiration,isOpened:!!e.opened_at,openedAt:e.opened_at,location:e.location?.name||"Non sp\xe9cifi\xe9",locationIcon:e.location?.icon||"\uD83D\uDCE6",urgency:{level:o.label,color:o.color,score:c},actions:p,recommendation:"CRITIQUE"===o.label?`âš ï¸ URGENT : V\xe9rifier l'\xe9tat et d\xe9cider imm\xe9diatement (cuisiner, congeler ou jeter si p\xe9rim\xe9)`:"URGENT"===o.label?`ðŸ”¥ \xc0 consommer ou congeler aujourd'hui`:"ATTENTION"===o.label?`â° Planifier utilisation dans les 3 prochains jours`:"BIENT\xd4T"===o.label?`ðŸ“… \xc0 pr\xe9voir dans la semaine`:e.opened_at?`ðŸ“¦ Lot ouvert : \xe0 surveiller`:`âœ… Rien \xe0 signaler`};l.push(m),d.totalAtRisk++,"CRITIQUE"===o.label?d.criticalCount++:"URGENT"===o.label?d.urgentCount++:"ATTENTION"===o.label&&d.warningCount++,d.totalQuantityAtRisk+=parseFloat(m.quantity||0);let g=m.category||"Autre";d.categoriesAtRisk[g]=(d.categoriesAtRisk[g]||0)+1}return l.sort((e,t)=>t.urgency.score-e.urgency.score),{risks:l,stats:d,summary:{total:d.totalAtRisk,critical:d.criticalCount,urgent:d.urgentCount,warning:d.warningCount,message:d.criticalCount>0?`âš ï¸ ${d.criticalCount} produit(s) n\xe9cessitent une action imm\xe9diate !`:d.urgentCount>0?`ðŸ”¥ ${d.urgentCount} produit(s) \xe0 consommer ou congeler rapidement`:d.warningCount>0?`â° ${d.warningCount} produit(s) \xe0 surveiller cette semaine`:`âœ… Pas de produits urgents \xe0 g\xe9rer`}}}catch(e){throw console.error("Erreur analyse anti-gaspillage:",e),e}}async function c(e,t){try{if(!t?.risks||0===t.risks.length)return{suggestions:[],message:"Aucun produit \xe0 risque"};let e=t.risks.slice(0,5).map(e=>e.productName),{data:r,error:n}=await o.OQ.from("recipes").select(`
        id,
        name,
        description,
        prep_time_minutes,
        cook_time_minutes,
        servings,
        role,
        recipe_ingredients!inner(
          id,
          quantity,
          unit,
          notes
        )
      `).limit(20);if(n)throw n;let a=[];for(let o of r||[]){let r=e.filter(e=>{let t=o.name.toLowerCase(),r=(o.description||"").toLowerCase(),n=e.toLowerCase();return t.includes(n)||r.includes(n)});r.length>0&&a.push({recipeId:o.id,recipeName:o.name,description:o.description,prepTime:o.prep_time_minutes,cookTime:o.cook_time_minutes,servings:o.servings,role:o.role,matchingProducts:r,matchCount:r.length,wasteReduction:function(e,t){let r=0;for(let o of e){let e=t.risks.find(e=>e.productName===o);e&&(r+=parseFloat(e.quantity||0))}return{quantity:Math.round(10*r)/10,estimatedValue:Math.round(5*r),co2:Math.round(25*r)/10}}(r,t),urgencyScore:r.reduce((e,r)=>{let o=t.risks.find(e=>e.productName===r);return e+(o?.urgency?.score||0)},0)/r.length})}return a.sort((e,t)=>t.matchCount!==e.matchCount?t.matchCount-e.matchCount:t.urgencyScore-e.urgencyScore),{suggestions:a.slice(0,10),message:a.length>0?`${a.length} recettes trouv\xe9es pour sauver vos produits`:"Aucune recette trouv\xe9e avec ces ingr\xe9dients"}}catch(e){throw console.error("Erreur suggestions recettes:",e),e}}async function l(e,t){let{lotId:r,actionType:n,quantitySaved:a,notes:i}=t;try{let{data:s,error:u}=await o.OQ.from("waste_prevention_log").insert({user_id:e,lot_id:r,action_type:n,quantity_saved:a,notes:i,created_at:new Date().toISOString()}).select().single();if(u)return console.log("Action anti-gaspillage:",t),{success:!0,logged:!1};return{success:!0,logged:!0,data:s}}catch(e){return console.error("Erreur log action:",e),{success:!1,error:e.message}}}async function d(e,t="month"){try{let r;let n=new Date;switch(t){case"week":r=new Date(n.getTime()-6048e5);break;case"month":default:r=new Date(n.getFullYear(),n.getMonth(),1);break;case"year":r=new Date(n.getFullYear(),0,1)}let{data:a,error:i}=await o.OQ.from("waste_prevention_log").select("*").eq("user_id",e).gte("created_at",r.toISOString());if(i&&"PGRST116"!==i.code)throw i;let s={period:t,totalActionsTaken:a?.length||0,quantitySaved:a?.reduce((e,t)=>e+(parseFloat(t.quantity_saved)||0),0)||0,actionBreakdown:{},estimatedMoneySaved:0,co2Saved:0};for(let e of a||[]){let t=e.action_type;s.actionBreakdown[t]=(s.actionBreakdown[t]||0)+1}return s.estimatedMoneySaved=Math.round(5*s.quantitySaved),s.co2Saved=Math.round(25*s.quantitySaved)/10,s}catch(e){return console.error("Erreur calcul stats:",e),{period:t,totalActionsTaken:0,quantitySaved:0,actionBreakdown:{},estimatedMoneySaved:0,co2Saved:0}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[948,766,70],()=>r(4630));module.exports=o})();